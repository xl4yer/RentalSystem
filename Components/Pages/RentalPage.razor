@page "/rentals"
@rendermode InteractiveServer

<MudTable Class="ma-3" Dense Hover Items="@rentals" Elevation="1" Style="border-radius:20px"
          HorizontalScrollbar FixedHeader FixedFooter Height="600px">
    <ToolBarContent>
        <MudText Typo="Typo.h5" Align="Align.Center" Style="font-family:'Segoe Script'">Rentals</MudText>
        <MudSpacer />
        <MudTextField T="string" Placeholder="Search Rentals..." Variant="Variant.Outlined" Margin="Margin.Dense" />
    </ToolBarContent>

    <HeaderContent>
        @foreach (var header in new[] { "Date", "Photo", "Customer Name", "Gown Name", "Status", "Due Date", "Action" })
        {
            <MudTh Style="background-color: #4E3434; color: white;">@header</MudTh>
        }
    </HeaderContent>
    <RowTemplate>
        <MudTd>@context.Date?.ToString("d")</MudTd>
        <MudTd>
            <img src="data:image/bmp;base64,@Convert.ToBase64String(context.Photo)" class="img-thumbnail rounded" style="max-width: 70px;" />
        </MudTd>
        <MudTd>@context.Fullname</MudTd>
        <MudTd>@context.Name</MudTd>
        <MudTd> <MudChip T="string" Color="@(context.Status == "OnGoing" ? Color.Success : context.Status == "Returned" ? Color.Warning : Color.Info)">@context.Status</MudChip></MudTd>
        <MudTd>@context.DueDate?.ToString("d")</MudTd>
        <MudTd>
            <MudButton Variant="Variant.Filled" Size="Size.Small" Color="Color.Primary">Actions</MudButton>
        </MudTd>
    </RowTemplate>
</MudTable>

@code {
    private Rentals[]? rentals;
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
            await LoadRentals();
    }
    private async Task LoadRentals()
    {
        try
        {
            using var client = new HttpClient { BaseAddress = new Uri(Nav.BaseUri) };
            var response = await client.GetAsync("api/Rental/Rentals");
            if (!response.IsSuccessStatusCode) return;

            await Task.Delay(1000);
            rentals = JsonConvert.DeserializeObject<Rentals[]>(await response.Content.ReadAsStringAsync());
            StateHasChanged();
        }
        catch (Exception ex)
        {
            SnackBar.Add($"Error: {ex.Message}", Severity.Error);
        }
    }

    private async Task Actions(string id)
    {
       
    }

    public async Task AddRental()
    {
        var parameters = new DialogParameters();
        var options = new DialogOptions
            {
                MaxWidth = MaxWidth.Small,
                FullWidth = true
            };
        var dialog = await Dialog.Show<AddToRentals>("", parameters, options).Result;
    }
}
